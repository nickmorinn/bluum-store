{%- liquid
  assign namespace = section.settings.metafield_namespace | default: 'custom'
  assign key = section.settings.metafield_key | default: 'research'
  assign research_page = nil
  assign research_content = ''

  if product
    assign selected_variant = product.selected_or_first_available_variant
    assign research_source = nil

    if selected_variant
      assign variant_namespace = selected_variant.metafields[namespace]
      if variant_namespace != blank and variant_namespace[key] != blank
        assign research_source = variant_namespace[key]
      endif
    endif

    if research_source == blank
      assign product_namespace = product.metafields[namespace]
      if product_namespace != blank and product_namespace[key] != blank
        assign research_source = product_namespace[key]
      endif
    endif

    if research_source != blank
      assign direct_page = research_source.value | default: research_source

      if direct_page.content != blank or direct_page.body_html != blank or direct_page.body != blank
        assign research_page = direct_page
      else
        assign page_field_handle = section.settings.metaobject_page_field | default: 'page'
        assign candidate_page = direct_page[page_field_handle]
        if candidate_page != blank
          assign page_drop = candidate_page.value | default: candidate_page
          if page_drop.content != blank or page_drop.body_html != blank or page_drop.body != blank
            assign research_page = page_drop
          endif
        endif
      endif
    endif
  endif

  if research_page
    assign research_content = research_page.content | default: research_page.body_html | default: research_page.body
  endif
-%}

{%- if research_page and research_content != blank -%}
<section class="product-research">
  <div class="product-research__container">

    {%- if research_page.image -%}
      <img
        class="product-research__hero"
        src="{{ research_page.image | image_url: width: 1600 }}"
        alt="{{ research_page.title | escape }}"
      >
    {%- endif -%}

    <header class="product-research__header">
      {%- if section.settings.subheading != blank -%}
        <p class="product-research__subheading">
          {{ section.settings.subheading }}
        </p>
      {%- endif -%}

      <h2 class="product-research__title">
        {{ section.settings.heading | default: research_page.title }}
      </h2>

      {%- if research_page.published_at -%}
        <p class="product-research__meta">
          {{ research_page.published_at | date: "%B %d, %Y" }}
        </p>
      {%- endif -%}
    </header>

    <article class="product-research__body prose">
      {{ research_content }}
    </article>

  </div>
</section>
{%- endif -%}

{% schema %}
{
  "name": "Product research",
  "tag": "section",
  "enabled_on": { "templates": ["product"] },
  "settings": [
    { "type": "text", "id": "metafield_namespace", "label": "Metafield namespace", "default": "custom" },
    { "type": "text", "id": "metafield_key", "label": "Metafield key", "default": "research" },
    { "type": "text", "id": "metaobject_page_field", "label": "Metaobject page field handle", "default": "page" },
    { "type": "text", "id": "subheading", "label": "Subheading" },
    { "type": "text", "id": "heading", "label": "Heading" }
  ],
  "presets": [
    { "name": "Product research (Blog Style)" }
  ]
}
{% endschema %}
