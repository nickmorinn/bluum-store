{% liquid
  assign shipping_protection_product = nil
  assign shipping_protection_variant = nil
  assign shipping_protection_in_cart = false
  assign shipping_protection_quantity = 0

  if settings.show_shipping_protection
    if settings.product_shipping_protection != blank
      assign shipping_protection_product = all_products[settings.product_shipping_protection]
    endif

    if shipping_protection_product == nil
      assign shipping_protection_product = all_products['shipping-insurance']
    endif

    if shipping_protection_product == nil
      assign shipping_protection_product = all_products['shipping-protection']
    endif

    if shipping_protection_product and shipping_protection_product.selected_or_first_available_variant
      assign shipping_protection_variant = shipping_protection_product.selected_or_first_available_variant

      for item in cart.items
        if item.variant_id == shipping_protection_variant.id
          assign shipping_protection_in_cart = true
          assign shipping_protection_quantity = item.quantity
          break
        endif
      endfor
    endif
  endif
%}

<cart-drawer {% if request.design_mode %}handle-section-events{% endif %} class="cart-drawer drawer drawer--lg" id="cart-drawer">
  {%- if cart.item_count == 0 -%}
    <button is="close-button" aria-label="{{ 'general.accessibility.close' | t | escape }}">
      {%- render 'icon' with 'close' -%}
    </button>

    <div class="empty-state align-self-center">
      <div class="empty-state__icon-wrapper">
        {%- render 'icon' with 'cart', width: 32, height: 32, stroke_width: 1 -%}
        <span class="count-bubble count-bubble--lg">0</span>
      </div>

      <div class="prose">
        <p class="h5">{{ 'cart.general.empty' | t }}</p>

        {%- assign button_content = 'cart.general.continue_shopping' | t -%}
        {%- render 'button', href: settings.cart_empty_button_link, size: 'xl', content: button_content -%}
      </div>
    </div>
  {%- else -%}
    <div class="cart-drawer__inner">
      {%- if shipping_protection_variant -%}
        <form
          id="ShippingProtectionForm"
          class="shipping-protection-form"
          action="{{ routes.cart_add_url }}.js"
          method="post"
          style="display: none;"
        >
          <input type="hidden" name="id" value="{{ shipping_protection_variant.id }}">
          <input type="hidden" name="quantity" value="1">
        </form>
      {%- endif -%}

      <div class="cart-drawer__top">
        <div class="h-stack items-center justify-between">
          <div class="h-stack grow gap-2 sm:gap-2.5">
            <p class="h5">{{- 'cart.general.title' | t -}}</p>
            <cart-count class="count-bubble count-bubble--md">{{ cart.item_count | minus: shipping_protection_quantity }}</cart-count>
          </div>

          <button type="button" is="close-button" class="drawer__close-icon">
            <span class="sr-only">{{ 'general.accessibility.close' | t }}</span>
            {%- render 'icon' with 'close' -%}
          </button>
        </div>

        {%- if settings.cart_show_free_shipping_threshold -%}
          {%- render 'free-shipping-bar' -%}
        {%- endif -%}
      </div>

      <div class="v-stack gap-6 sm:gap-8">
        <div class="cart-drawer__line-items">
          {%- for line_item in cart.items -%}
            {%- if shipping_protection_variant and line_item.variant_id == shipping_protection_variant.id -%}
              {%- continue -%}
            {%- endif -%}
            {%- render 'line-item', line_item: line_item, show_desktop_quantity: true -%}
          {%- endfor -%}
        </div>

        {%- if section.settings.products.count > 0 -%}
          <div class="cart-drawer__recommendations">
            <div class="v-stack gap-2.5 sm:gap-4">
              {%- capture carousel_id -%}cart-drawer-recommendations{%- endcapture -%}

              {%- liquid
                assign horizontal_products_blends = true
                assign product_card_background = section.settings.product_card_background | default: product.settings.product_card_background

                if product_card_background != 'rgba(0,0,0,0)' and product_card_background != blank and product_card_background != settings.dialog_background
                  assign horizontal_products_blends = false
                endif

                assign rendered_recommendations = 0

                capture recommendations
                  for recommended_product in section.settings.products
                    assign item_count_in_cart = cart | line_items_for: recommended_product

                    if item_count_in_cart.size == 0
                      render 'horizontal-product', product: recommended_product, show_add_to_cart: true, background: section.settings.product_card_background, text_color: section.settings.product_card_text_color
                      assign rendered_recommendations = rendered_recommendations | plus: 1
                    endif
                  endfor
                endcapture
              -%}

              {%- if rendered_recommendations > 0 -%}
                <div class="h-stack justify-between gap-4">
                  {%- if section.settings.recommendations_title != blank -%}
                    <p>{{ section.settings.recommendations_title | escape }}</p>
                  {%- endif -%}

                  {%- if rendered_recommendations > 1 -%}
                    <div class="h-stack gap-2 hidden sm:flex">
                      <button is="prev-button" class="circle-chevron hover:colors" aria-controls="{{ carousel_id }}" aria-label="{{ 'general.accessibility.previous' | t | escape }}" disabled>{%- render 'icon' with 'chevron-left-small', direction_aware: true -%}</button>
                      <button is="next-button" class="circle-chevron hover:colors" aria-controls="{{ carousel_id }}" aria-label="{{ 'general.accessibility.next' | t | escape }}">{%- render 'icon' with 'chevron-right-small', direction_aware: true -%}</button>
                    </div>
                  {%- endif -%}
                </div>
              {%- endif -%}

              {%- if recommendations != blank -%}
                <scroll-carousel selector=".horizontal-product" id="{{ carousel_id }}" class="horizontal-product-list-carousel {% unless horizontal_products_blends %}separate{% endunless %} scroll-area bleed">
                  <div class="horizontal-product-list {% if horizontal_products_blends %}divide-x{% else %}separate{% endif %}">
                    {{- recommendations -}}
                  </div>
                </scroll-carousel>
              {%- endif -%}
            </div>
          </div>
        {%- endif -%}
      </div>
    </div>

    <div class="v-stack gap-4 sm:gap-6" slot="footer">
      <div class="v-stack gap-1">
        {% if shipping_protection_variant %}
          {%- assign shipping_heading = settings.shipping_protection_heading | default: 'Shipping Insurance' -%}

          <div
            class="shipping-protection-card{% if shipping_protection_in_cart %} is-selected{% endif %}"
            data-shipping-protection
            data-variant-id="{{ shipping_protection_variant.id }}"
            data-product-handle="{{ shipping_protection_product.handle }}"
            data-selected="{{ shipping_protection_in_cart }}"
            aria-live="polite"
          >
            <div class="shipping-protection-card__layout">
              <div class="shipping-protection-card__info">
                <div class="shipping-protection-card__icon">
                  {% if settings.shipping_protection_icon != blank %}
                    <img
                      src="{{ settings.shipping_protection_icon | image_url: width: 80 }}"
                      width="40"
                      height="40"
                      loading="lazy"
                      alt="{{ shipping_heading | escape }}"
                    >
                  {% else %}
                    <img
                      src="https://cdn.shopify.com/s/files/1/0676/6270/8931/files/shipping-insurance.png?v=1752899311"
                      width="40"
                      height="40"
                      loading="lazy"
                      alt="{{ shipping_heading | escape }}"
                    >
                  {% endif %}
                </div>

                <div class="shipping-protection-card__content">
                  <p class="bold shipping-protection-card__heading">
                    {{ shipping_heading | escape }}
                    <span class="shipping-protection-card__price">{{ shipping_protection_variant.price | money }}</span>
                  </p>
                </div>
              </div>

              <div class="shipping-protection-card__controls">
                <label class="shipping-protection-card__toggle" aria-label="{{ 'Add shipping protection' | escape }}">
                  <input
                    type="checkbox"
                    class="switch"
                    data-shipping-protection-toggle
                    data-variant-id="{{ shipping_protection_variant.id }}"
                    data-product-handle="{{ shipping_protection_product.handle }}"
                    {% if shipping_protection_in_cart %}checked{% endif %}
                    {% unless shipping_protection_variant.available %}disabled{% endunless %}
                  >
                </label>

                {% unless shipping_protection_variant.available %}
                  <span class="text-xs text-subdued">{{ 'products.product.sold_out' | t }}</span>
                {% endunless %}
              </div>
            </div>
          </div>
        {% endif %}

        {% for discount_application in cart.cart_level_discount_applications %}
          <div class="h-stack gap-4 justify-between">
            <div class="badge">
              {%- render 'icon' with 'discount' -%} {{- discount_application.title -}}
            </div>

            <span class="text-subdued">-{{ discount_application.total_allocated_amount | money }}</span>
          </div>
        {% endfor %}

        <div class="h-stack gap-4 justify-between">
          <span class="h5">{{ 'cart.general.total' | t }}</span>
          <span class="h5">{{- cart.total_price | money_with_currency -}}</span>
        </div>

        {%- if section.settings.show_shipping_text -%}
          {%- if cart.taxes_included and shop.shipping_policy.body != blank -%}
            <p class="text-subdued text-sm">{{ 'cart.general.taxes_included_and_shipping_policy_html' | t: link: shop.shipping_policy.url }}</p>
          {%- elsif cart.taxes_included -%}
            <p class="text-subdued text-sm">{{ 'cart.general.taxes_included_but_shipping_at_checkout' | t }}</p>
          {%- elsif shop.shipping_policy.body != blank -%}
            <p class="text-subdued text-sm">{{ 'cart.general.taxes_and_shipping_policy_at_checkout_html' | t: link: shop.shipping_policy.url }}</p>
          {%- else -%}
            <p class="text-subdued text-sm">{{ 'cart.general.taxes_and_shipping_at_checkout' | t }}</p>
          {%- endif -%}
        {%- endif -%}

        {%- if section.settings.show_cart_note -%}
          <button type="button" class="justify-self-start" aria-controls="cart-drawer-note">
            <span class="link text-sm text-subdued">
              {%- if cart.note == blank -%}
                {{- 'cart.general.add_order_note' | t -}}
              {%- else -%}
                {{- 'cart.general.edit_order_note' | t -}}
              {%- endif -%}
            </span>
          </button>

          <cart-note-dialog id="cart-drawer-note" class="cart-drawer__note">
            <div class="cart-drawer__note-inner">
              <div class="v-stack gap-4 sm:gap-6">
                <p class="h5">{{ 'cart.general.order_note' | t }}</p>

                <cart-note class="v-stack gap-4">
                  {%- assign order_note = 'cart.general.order_note' | t -%}
                  {%- assign order_save_label = 'cart.general.save_note' | t -%}

                  {%- render 'input', name: 'note', multiline: 3, label: order_note, value: cart.note -%}

                  <div class="justify-self-start">
                    {%- render 'button', type: 'button', content: order_save_label, size: 'lg', is: 'close-button', secondary: true -%}
                  </div>
                </cart-note>
              </div>
            </div>
          </cart-note-dialog>
        {%- endif -%}
      </div>

      <form action="{{ routes.cart_url }}" method="POST" class="buy-buttons {% if section.settings.show_checkout_button %}buy-buttons--compact{% endif %}">
        {%- assign checkout_label = 'cart.general.checkout' | t -%}

        <div class="v-stack gap-4">
          <div class="text-sm">
            By checking out, I confirm that I have read, understood and agreed with your <a href="{{ section.settings.terms_of_service_url }}" class="link" target="_blank">Terms of Service</a> and <a href="{{ section.settings.waiver_agreement_url }}" class="link" target="_blank">Waiver Agreement</a>. I certify that these products will not be used on humans.
          </div>

          {%- if section.settings.show_view_cart_button or section.settings.show_checkout_button == false -%}
            <a href="{{ routes.cart_url }}" class="button button--xl {% if section.settings.show_checkout_button %}button--secondary{% endif %}" data-no-instant>
              {{- 'cart.general.view_cart' | t -}}
            </a>
          {%- endif -%}

          {%- if section.settings.show_checkout_button -%}
            <div id="checkout-wrapper" class="w-full">
              {%- render 'button', type: 'submit', content: checkout_label, icon: 'picto-lock', name: 'checkout', size: 'xl', stretch: true -%}
            </div>
          {%- endif -%}
        </div>
      </form>
    </div>
  {%- endif -%}
</cart-drawer>

<script>
  (() => {
    if (window.__shippingProtectionToggleInitialized) return;
    window.__shippingProtectionToggleInitialized = true;

    const selectors = {
      toggle: '[data-shipping-protection-toggle]',
      container: '[data-shipping-protection]'
    };

    const dispatchCartChange = (baseEvent, cartContent) => {
      document.documentElement.dispatchEvent(
        new CustomEvent('cart:change', {
          bubbles: true,
          detail: { baseEvent, cart: cartContent }
        })
      );
    };

    const prepareSections = () => {
      const sections = [];
      document.documentElement.dispatchEvent(
        new CustomEvent('cart:prepare-bundled-sections', {
          bubbles: true,
          detail: { sections }
        })
      );
      return sections;
    };

    const setLoadingState = (toggle, isLoading) => {
      const wasDisabled = toggle.dataset.baseDisabled || toggle.hasAttribute('disabled');

      if (isLoading) {
        toggle.dataset.baseDisabled = wasDisabled ? 'true' : 'false';
        toggle.disabled = true;
      } else if (toggle.dataset.baseDisabled !== 'true') {
        toggle.disabled = false;
      }
    };

    const syncFromCart = (cart) => {
      document.querySelectorAll(selectors.container).forEach((container) => {
        const variantId = Number(container.dataset.variantId);
        if (!variantId) return;

        const toggle = container.querySelector(selectors.toggle);
        const inCart = cart?.items?.some(
          (item) => item.variant_id === variantId || item.id === variantId
        );

        container.dataset.selected = inCart ? 'true' : 'false';
        container.classList.toggle('is-selected', !!inCart);

        if (toggle) {
          toggle.checked = !!inCart;
        }
      });
    };

    const addProtection = async () => {
      const form = document.getElementById('ShippingProtectionForm');
      if (!form) {
        throw new Error('Shipping protection form is missing.');
      }

      const formData = new FormData(form);
      const sections = prepareSections();

      if (sections.length) {
        formData.set('sections', sections.join(','));
        formData.set('sections_url', window.location.pathname);
      }

      const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          Accept: 'application/json'
        }
      });

      const json = await response.json();
      if (!response.ok) {
        throw new Error(json.description || 'Unable to add shipping protection.');
      }

      const cartContent = await (await fetch(`${Shopify.routes.root}cart.js`)).json();
      cartContent.sections = json.sections;
      dispatchCartChange('shipping-protection:add', cartContent);
      return cartContent;
    };

    const removeProtection = async (variantId) => {
      const sections = prepareSections();
      const payload = {
        updates: {
          [variantId]: 0
        }
      };

      if (sections.length) {
        payload.sections = sections.join(',');
        payload.sections_url = window.location.pathname;
      }

      const response = await fetch(`${Shopify.routes.root}cart/update.js`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const cartContent = await response.json();
      if (!response.ok) {
        throw new Error(cartContent?.description || 'Unable to remove shipping protection.');
      }

      dispatchCartChange('shipping-protection:remove', cartContent);
      syncFromCart(cartContent);
      return cartContent;
    };

    document.addEventListener('change', async (event) => {
      if (!event.target.matches(selectors.toggle)) return;

      const toggle = event.target;
      const variantId = Number(toggle.dataset.variantId);
      if (!variantId) return;

      setLoadingState(toggle, true);

      try {
        if (toggle.checked) {
          await addProtection();
        } else {
          await removeProtection(variantId);
        }
      } catch (error) {
        console.error('Shipping protection update failed', error);
        toggle.checked = !toggle.checked;
      } finally {
        setLoadingState(toggle, false);
      }
    });

    document.addEventListener('cart:change', (event) => {
      if (!event.detail?.cart) return;
      syncFromCart(event.detail.cart);
    });
  })();
</script>

{% schema %}
{
  "name": "Cart drawer",
  "settings": [
    {
      "type": "paragraph",
      "content": "Cart drawer won't appear to your customers if you have set the cart type to Page in the global theme settings."
    },
    {
      "type": "paragraph",
      "content": "Free shipping bar can be configured in global cart settings."
    },
    {
      "type": "checkbox",
      "id": "show_cart_note",
      "label": "Show cart note",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_shipping_text",
      "label": "Show shipping text",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_view_cart_button",
      "label": "Show view cart button",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_checkout_button",
      "label": "Show checkout button",
      "default": true
    },
    {
      "type": "header",
      "content": "Product recommendations"
    },
    {
      "type": "text",
      "id": "recommendations_title",
      "label": "Heading",
      "default": "Trending this month"
    },
    {
      "type": "product_list",
      "id": "products",
      "label": "Recommendations",
      "info": "Suggest additional products to your customers. Recommendations already in the cart are automatically hidden.",
      "limit": 10
    },
    {
      "type": "color",
      "id": "product_card_background",
      "label": "Product card background"
    },
    {
      "type": "color",
      "id": "product_card_text_color",
      "label": "Product card text"
    },
    {
      "type": "header",
      "content": "Legal Documents"
    },
    {
      "type": "url",
      "id": "terms_of_service_url",
      "label": "Terms of Service URL",
      "info": "Link to your Terms of Service document"
    },
    {
      "type": "url",
      "id": "waiver_agreement_url",
      "label": "Waiver Agreement URL",
      "info": "Link to your Waiver Agreement document"
    }
  ]
}
{% endschema %}
